<table class='tblSearch'>
    <tr>
        <td>Type</td><td id='tdSelectCateg'></td>
    </tr>
    <tr>
        <td>Zone du corps</td><td id='tdSelectZones'></td>
    </tr>
    <tr>
        <td>Difficult√©</td><td id='tdSelectDiff'></td><td class='tdButtonClearSearch'><button class='imgButtonSmall' id='btnClearSearch'><img/>&nbsp;</button></td>
    </tr>
</table>
<hr/>
<div id='divResultsExercices'></div>
<script>
    var exoPage = {
        // init page components
        initialise: () => {
            var result = $.Deferred();
            
            var get1 = dataManager.getCategories();
            var get2 = dataManager.getDifficultes();
            var get3 = dataManager.getZones();
            
            $('#btnClearSearch').click(() => {
                $('.tblSearch select').val(-1);
                exoPage.searchExercices();
            });

            $.when(get1, get2, get3).done((data1, data2, data3) => {
                data1.splice(0,0,new Categorie(-1,"-", "-"));
                var render1 = pageManager.renderElement('selectElement', data1, 'tdSelectCateg');
                data2.splice(0,0,new Difficulte(-1,"-"));
                var render2 = pageManager.renderElement('selectElement', data2, 'tdSelectDiff'); 
                data3.splice(0,0,new Zone(-1,"-"));
                var render3 = pageManager.renderElement('selectElement', data3, 'tdSelectZones');
                $.when(render1, render2, render3).done(() => {
                    $('#tdSelectCateg select').data('type','categ');
                    $('#tdSelectZones select').data('type','zone');
                    $('#tdSelectDiff select').data('type','diff');
                    $('.tblSearch select').on("change", () => { exoPage.searchExercices(); });
                    result.resolve(); 
                });
            });
            
            return result.promise();
        },
        showExercices: (exercices) => {
            // Display results
            pageManager.renderElement('exo/listElementsExerc', exercices, 'divResultsExercices').done(function(html) {                  
                // Replace ids with values
                $('.ulResults td').each(function(){
                    var data = $(this).data();
                    if (data) {
                        if (data.categ) {
                            dataManager.getCategorie(data.categ).done((item) => {
                               $(this).html(item.nom); 
                            });
                        }
                        if (data.diff) {
                            dataManager.getDifficulte(data.diff).done((item) => {
                               $(this).html(item.nom); 
                            });
                        }
                    }
                }); 
            });
        },
        // Perform exercices search 
        searchExercices: () => {
            // Search exercices
            let listFilterFields = [$("#tdSelectCateg select"),$("#tdSelectZones select"),$("#tdSelectDiff select")];
            filterManager.filterExercices(listFilterFields).done(function(results) {   
                exoPage.showExercices(results);
            });
        },
        // Show popin exercice details
        showDetailPopin: (id) => {
            popinManager.load('OK').done(() => {
                dataManager.getExercice(id).done((objExercice) => {
    				var paramObj = [];
    				paramObj.push(objExercice);
    				pageManager.renderElement('exo/popinDetailExerc', paramObj, 'tdPopinContent').done((html) => {
    					// replace id by values
                        var cat = dataManager.getCategorie(objExercice.categorie_id);
                        var dif = dataManager.getDifficulte(objExercice.difficulte_id);
                        var zon = dataManager.getZonesByIds(objExercice.zone_du_corps_id);
                        $.when(cat,dif,zon).done((c,d,z)=>{
                            $("#categorie_id").html(c.nom);
                            $("#difficulte_id").html(d.nom);
                            var zones = "";
                            $(z).each(function() {
                                if (zones!='') zones += ', ';
                                zones += this.nom;
                            });
                            $("#zone_du_corps_id").html(zones);
                        });
                        // show/hide delete button
                        var customExo = $("#tblDetailExerc").data('custom');
                        $("#divDetailExercButtons").hide();
                        if (customExo) {
                            var html = $("#divDetailExercButtons").html();
                            $(".trPopinHeader td").html(html);                            
                        }
                        
                        // show popin
                        popinManager.show();
    				});
    			});
            });
        },
        // Validate creation popin
        validateCreatePopin: (popinResult) => {
            var arrayResult = popinResult.split('|');
            var cpt = 0;

            // get data and create new exercice
            var id = new Date().getTime();
            var nom = arrayResult[cpt].substr(arrayResult[cpt++].indexOf('=')+1);
            var categ = arrayResult[cpt].substr(arrayResult[cpt++].indexOf('=')+1);
            var zone = arrayResult[cpt].substr(arrayResult[cpt++].indexOf('=')+1);
            var diff = arrayResult[cpt].substr(arrayResult[cpt++].indexOf('=')+1);
            var desc = arrayResult[cpt].substr(arrayResult[cpt++].indexOf('=')+1);
            var etap = arrayResult[cpt].substr(arrayResult[cpt++].indexOf('=')+1);
            var unit = arrayResult[cpt].substr(arrayResult[cpt++].indexOf('=')+1);
            
            // add new exercice
            dataManager.addCustomExercice(new Exercice(id, nom, categ, zone, diff, desc, true, etap, unit));
            
            // refresh list
            exoPage.searchExercices();
        },
        // Delete exercice
        deleteExercice: (id) => {
            dataManager.deleteCustomExercice(id).done(() => {
                // refresh list
                exoPage.searchExercices();
            });
        }
    }
    
    exoPage.initialise().done(() => {
        exoPage.searchExercices();
    });
</script>