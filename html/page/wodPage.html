<div class='divWodContent'>
    <table id='tblWodTitleDate'>
        <tr>
            <td id='tdWodName'></td>
            <td><button class='imgButtonSmall edit' id='btnEditWodName'/></td>
        </tr>
    </table>
    <table id='tblWodActions'>
        <tr>
            <td><button class='imgButtonBig' id='btnWodAddExo'>Exercices</button></td>
            <td><button class='imgButtonBig' id='btnWodAddRest'>Repos</button></td>
            <td><button class='imgButtonBig' id='btnWodAddSerie'>Série</button></td>
        </tr>
    </table>
    <hr/>
    <table id='tblWodItems'></table>   
</div>
<script>
    // wod page actions
    var wodPage = {
        wodItems: [],
        selectedWodItems: [],
        
        // init page components
        initialise: () => {
            let result = $.Deferred();
            result.resolve();
            return result.promise();
        },
        // Add Rest item
        addWodRestItem:() => {
            let idRandom = new Date().getTime();
            wodPage.wodItems.push(new WodItem('REST', idRandom, "Repos (secondes)", 30, "sec"));
            wodPage.renderWodItems();
        },
        // Add Rest item
        addWodSerieItem:() => {
            let idRandom = new Date().getTime();
            wodPage.wodItems.push(new WodItem('SERIE', idRandom, "Série (Loop)", 5, "rep"));
            wodPage.renderWodItems();
        },
        // Edit wod item quantity
        editWodItemQtt:(obj) => {
            let parent = $(obj).parents('.trWodRow')[0];
            let itemUid = $(parent).data('uid');
            let currentValue = $(obj).val()*1;
            wodPage.wodItems.forEach((item) => { 
                if (item.uid == itemUid) {
                    item.quantite=currentValue;
                    return;
                } 
            });
        },
        editWodItemUnit:(obj) => {
            let parent = $(obj).parents('.trWodRow')[0];
            let itemUid = $(parent).data('uid');
            let currentValue = $(obj).val();
            wodPage.wodItems.forEach((item) => { 
                if (item.uid == itemUid) {
                    item.unite=currentValue;
                    return;
                } 
            });
        },
        // Add WOD item
        addWodItem: () => {
            popinManager.setCallbackFunction('wodPage.validateWodItems()');
            popinManager.load('OKCancel').done(() => {
                pageManager.renderElement('wod/popinSelectWodItems', null, 'tdPopinContent').done((html) => {
                    let get1 = dataManager.getCategories();
                    let get2 = dataManager.getDifficultes();
                    let get3 = dataManager.getZones();
                    $.when(get1, get2, get3).done((data1, data2, data3) => {
                        data1.splice(0,0,new Categorie(-1,"-"));
                        let render1 = pageManager.renderElement('selectElement', data1, 'divCritereCateg');
                        data2.splice(0,0,new Difficulte(-1,"-"));
                        let render2 = pageManager.renderElement('selectElement', data2, 'divCritereDiff'); 
                        data3.splice(0,0,new Zone(-1,"-"));
                        let render3 = pageManager.renderElement('selectElement', data3, 'divCritereZone');
                        $.when(render1, render2, render3).done(() => {
                            $("#divCritereCateg select").data("type","categ");
                            $("#divCritereDiff select").data("type","diff");
                            $("#divCritereZone select").data("type","zone");
                            $("#tdPopinContent select").on("change", () => { wodPage.filterWodItems(); });
                            $("#btnWodItemsClear").on("click", () => {
                                $('#tdPopinContent select').val(-1);
                                wodPage.filterWodItems();    
                            });
                            wodPage.filterWodItems();
                            wodPage.selectedWodItems = [];
                            popinManager.show();
                        });
                    });
                });
            });
        },
        // Render wod items list on wod page
        renderWodItems:() => {
            let result = $.Deferred();
            pageManager.renderElement('wod/listExoWod', wodPage.wodItems, 'tblWodItems').done(()=>{
                $("#tblWodItems #btnDeleteExerc").on("click", (obj) => {
                    let parent = $(obj.currentTarget).parents('.trWodRow');
                    let uid = $(parent).data('uid');
                    wodPage.wodItems.forEach((item, index) => {
                        if (item.uid==uid) {
                            wodPage.wodItems.splice(index,1);
                        };
                    });
                    wodPage.renderWodItems();
                });

                // set values
                wodPage.wodItems.forEach((item) => {
                    $(".trWodRow[data-id='" + item.exerciceId + "'] input").val(item.quantite);
                    $(".trWodRow[data-id='" + item.exerciceId + "'] .selUnite").val(item.unite);
                });
                
                result.resolve();
            });
            return result.promise();
        },
        // Validate Wod items selection
        validateWodItems: (data) => {
            let listIdExoSelected = [];
            wodPage.selectedWodItems.forEach((item) => {
                listIdExoSelected.push(item*1);
            });
            dataManager.getExercicesByIds(listIdExoSelected).done(function(listExo) {
                let listWodItems = [];
                listExo.forEach((exo, index) => {
                    let item = new WodItem('EXO', exo.id, exo.nom, 10, exo.unite)
                    item.uid = "" + new Date().getTime() + index;
                    listWodItems.push(item);
                });
                wodPage.wodItems = wodPage.wodItems.concat(listWodItems);
                wodPage.renderWodItems();
            });
        },
        // Select a Wod on the selection list (add it to selecteditems)
        selectWodItem: (obj) => {
            let parent = $(obj).parents('.trWodItem');
            let dataKeyForm = $(parent).children('.keyForm');
            let id = $(dataKeyForm).attr('field');
            if (obj.checked) {
                wodPage.selectedWodItems.push(id);
            }
            else {
                let pos = wodPage.selectedWodItems.indexOf(id);
                wodPage.selectedWodItems.splice(pos,1);
            }
        },
        // check selected items on content change
        checkSelectedItems: () => {
            if (wodPage.selectedWodItems.length>0) {
                $.each($(".trWodItem"), function(i, item) {
                    let tdData = $(item).children('.keyForm');
                    let currentId = $(tdData).attr('field');
                    if (wodPage.selectedWodItems.indexOf(currentId)>-1) {
                        let checkBox = $(item).find('#chkExoWodChecked');
                        $(checkBox).prop('checked', true);
                    } 
                });
            }
        },
        // Filter items on addWodItem popin
        filterWodItems:() => {
            // Search exercices
            let listCriteresElements = [$("#divCritereCateg select"),$("#divCritereZone select"),$("#divCritereDiff select")];
            filterManager.filterExercices(listCriteresElements).done(function(results) {
                pageManager.renderElement('wod/listExoWodSelect', results, 'divWodItemsResults').done(()=>{
                    // Replace ids with values
                    $('.tblExoListWod td').each(function(){
                        let data = $(this).data();
                        if (data) {
                            if (data.categ) {
                                dataManager.getCategorie(data.categ).done((item) => {
                                   $(this).html(item.nom); 
                                });
                            }
                            if (data.diff) {
                                dataManager.getDifficulte(data.diff).done((item) => {
                                   $(this).html(item.nom); 
                                });
                            }
                        }
                    });
                    // Check selected items
                    wodPage.checkSelectedItems();
                })
            });
        },
        // Edit the WOD Name
        editWodName:() => {
            if ($("#btnEditWodName").hasClass('edit')) {
                let object = new injectableObject();
                object.value = $("#tdWodName").html();
                pageManager.renderElement('wod/editWodName', [object], 'tdWodName').done(()=>{
                    $("#btnEditWodName").toggleClass(['edit','save']);
                });
            }
            if ($("#btnEditWodName").hasClass('save')) {
                $("#tdWodName").html($("#txtWodName").val());
                $("#btnEditWodName").toggleClass(['edit','save']);
            }
        },
        // Swith to running state (desactivate GUI editing mode)
        DesactivateEditionMode: () => {
            // exit name edition mode & hide button
            if ($("#btnEditWodName").hasClass('save')) wodPage.editWodName();
            $("#btnEditWodName").hide();
            
            // Switch to display mode
            $("#btnWodAddExo").hide();
            $("#btnWodAddRest").hide();
            $("#btnWodAddSerie").hide();
            $("#tblWodItems #btnDeleteExerc").hide();
            $(".trWodRow input").attr('readonly', true);
            $(".trWodRow input").toggleClass('readonly');
            $(".trWodRow .selUnite option").attr('disabled', 'disabled');
            $(".trWodRow .selUnite").toggleClass('readonly');
        },
        // Hide wod running popin
        hideWodRunningPopin:() => {

            // add results zone
            $('.divWodContent').append("<div id='divWodResults'></div>");
            
            // Hide popin
            popinManager.hide();
            
            // Display running wod stats
            statisticsManager.showWodZonesStatistics(wodRunner.currentWod, 'divWodResults', 'Détails du WOD');
        }
    };

    // run wods
    var wodRunner = {
        currentWod: {},
        listWodItems: [],
        index1stWodItem: 0,
        indexCurrentWodItem:0,
        loopCounter: 1,
        timerDuration: 0,
        timer: {},
        
        // Start the wod
        startWod:() => {
            // Check currentWod
            if (wodRunner.currentWod.id) return;
            
            // Check exercices
            let exercices = wodPage.wodItems.filter((item) => { if (item.type=='EXO') return item; });
            if (exercices.length==0) return;

            // Desactivate edition mode
            wodPage.DesactivateEditionMode();
            
            // Create WOD
            let wodName = $("#tdWodName").html();
            let idRandom = new Date().getTime();
            wodRunner.currentWod = new Wod(idRandom, wodName, wodPage.wodItems);
            
            // add start date
            wodRunner.currentWod.dateDebut = new Date();

            // initial state
            wodRunner.indexCurrentWodItem = 0;
            wodRunner.index1stWodItem = 0;
            wodRunner.loopCounter = 1;
            wodRunner.listWodItems.push(wodRunner.currentWod.wodItems[0]);

            // render wod items
            wodRunner.renderListWodItems();
        },
        // Render list of current wod items
        renderListWodItems:() => {
            pageManager.renderElement('popin/popinWod', null, 'divPopin').done(() => {
                pageManager.renderElement('wod/currentWodPopin', [wodRunner.currentWod], 'tdPopinContent').done(()=>{
                    pageManager.renderElement('wod/listWodItems', wodRunner.listWodItems, 'tdListWodItems').done(()=>{

                        // Build header text
                        let txtExos = "Exercice " + ((wodRunner.indexCurrentWodItem - wodRunner.index1stWodItem) + 1) + "/" + (wodRunner.currentWod.wodItems.length - wodRunner.index1stWodItem);
                        let txtButton = "<button class='imgButtonSmall btnHeaderWodRunning'></button>";
                        let textSeries = "";
                        
                        // if current item is in loop : add loop headers
                        let cptItemsLoop = 0;
                        let currentIndex = wodRunner.index1stWodItem;
                        let found = false;
                        while (!found && currentIndex<wodRunner.currentWod.wodItems.length) {
                            if (wodRunner.currentWod.wodItems[currentIndex].type == 'SERIE') {
                                textSeries = "Série " + wodRunner.loopCounter + "/" + wodRunner.currentWod.wodItems[currentIndex].quantite;
                                txtExos = "Exercice " + ((wodRunner.indexCurrentWodItem - wodRunner.index1stWodItem) + 1) + "/" + cptItemsLoop;
                                found = true;
                            }
                            currentIndex++;
                            cptItemsLoop++;
                        }
                        let textHeader = txtButton + " " + txtExos;
                        if (textSeries!='') textHeader += " - " + textSeries;
                        $("#tdHeaderRunningWod").html(textHeader);
                        
                        // update WOD advancement (check done states)
                        let chkDoneList = $(".tblListWodItems #chkDone");
                        chkDoneList.each((index, item) => {
                            if (index!=wodRunner.indexCurrentWodItem) {
                                $(item).prop('checked', true);
                                $(item).prop('disabled', true);
                            }
                        });
                        
                        // show popin
                        popinManager.show();

                        // Ensure last item is visible
                        $('.divListWodItems').scrollTop(9999);
                        
                        // execute current wod item if no user action needed (rest/loops)
                        wodRunner.executeWodItem();
                    });
                });
            });
        },
        // execute current wod item if no user action needed (rest/loops)
        executeWodItem:() => {
            // Get current woditem
            let currentWodItem = wodRunner.currentWod.wodItems[wodRunner.indexCurrentWodItem];
            
            // if current WodItem unit is 'sec', start timer to perform action after a delay
            if (currentWodItem.unite=='sec') {
                // Hide checkbox done
                const currentRow = $('.trWodItemRow')[wodRunner.indexCurrentWodItem];
                const objChkDone = $(currentRow).find('#chkDone');
                $(objChkDone).hide();
                
                // start timer
                wodRunner.timerDuration = currentWodItem.quantite;
                wodRunner.timer = setInterval(() => {
                    wodRunner.timerDuration--;
                    // check timer end
                    if (wodRunner.timerDuration == 0) {
                        clearInterval(wodRunner.timer);
                        $(objChkDone).show();
                    }
                    // get current item and set countdown value
                    let objTdQte = $(currentRow).children('.tdQteWodItem');
                    $(objTdQte).html(wodRunner.timerDuration);
                }, 1000);
            }

            // if current woditem is LOOP, go to 1st wod item and increment loopCounter
            if (currentWodItem.type=='SERIE') {
                const currentRow = $('.trWodItemRow')[wodRunner.indexCurrentWodItem];
                let loopValue = $(currentRow).children('.tdQteWodItem').html();
                if (wodRunner.loopCounter<loopValue) {
                    wodRunner.loopCounter++;
                    wodRunner.indexCurrentWodItem = wodRunner.index1stWodItem;
                    wodRunner.listWodItems.splice(wodRunner.indexCurrentWodItem+1);
                    wodRunner.renderListWodItems();
                }
                else {
                    let objChkDone = $(currentRow).find('#chkDone');
                    $(objChkDone).show();
                    $(objChkDone).prop('checked', true);
                    wodRunner.loopCounter = 1;
                    wodRunner.index1stWodItem = wodRunner.indexCurrentWodItem + 1;
                    wodRunner.moveNextWodItem($(objChkDone));
                }
            }
        },
        // move to next Wod item in list
        moveNextWodItem:(obj) => {
            let isChecked = $(obj).prop("checked");
            if (isChecked) {
                if (wodRunner.indexCurrentWodItem==wodRunner.currentWod.wodItems.length-1) {
                    wodRunner.terminateWod();
                }
                else {
                    wodRunner.indexCurrentWodItem++;
                    wodRunner.listWodItems.push(wodRunner.currentWod.wodItems[wodRunner.indexCurrentWodItem]);
                    wodRunner.renderListWodItems();
                }
            }
        },
        // Terminate WOD
        terminateWod:() => {
            // wod completed
            wodRunner.currentWod.dateFin = new Date();

            // Add to recent
            dataManager.addWodToRecent(wodRunner.currentWod);
            
            // Change state
            $(".tblListWodItems #chkDone").prop('checked', true);
            $(".tblListWodItems #chkDone").prop('disabled', true);

            // Switch buttons
            $("#btnPopinAnnulerWod").toggleClass(["btnCancelButton", "btnCloseButton"]);
            $("#btnPopinAnnulerWod").html("Fermer");
            $(".btnStartWod").html("Nouveau");
            $(".btnStartWod").toggleClass(["btnStartWod", "btnNewWod"]);
            
            // display text
            let txtButton = "<button class='imgButtonSmall btnHeaderWodTerminated'></button>";
            $("#tdHeaderRunningWod").html(txtButton + " WOD Terminé !");
            
            // set btn new wod action
            $('.btnNewWod').click(function() {
                pageManager.renderFooter("footerMenuWod");
                pageManager.renderPage("wodPage");
            });
        }
    };
    
    wodPage.initialise().done(() => {
        // update current wod name
        let date = new Date();
        $("#tdWodName").html("Wod du " + date.toLocaleDateString() + ' à ' + date.toLocaleTimeString());

        // buttons clic
        $("#btnWodAddExo").click(()=>wodPage.addWodItem());
        $("#btnWodAddRest").click(()=>wodPage.addWodRestItem());
        $("#btnWodAddSerie").click(()=>wodPage.addWodSerieItem());
        $("#btnEditWodName").click(()=>wodPage.editWodName());
    });
    
</script>