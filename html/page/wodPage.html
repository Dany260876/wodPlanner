<div>
    <table id='tblWodTitleDate'>
        <tr>
            <td id='tdWodName'></td>
            <td><button class='imgButtonSmall edit' id='btnEditWodName'/></td>
        </tr>
    </table>
    <hr/>
    <table id='tblWodItems'></table>
    <br/>
    <table id='tblWodActions'>
        <tr>
            <td><button class='imgButtonBig' id='btnWodAddExo'>Exercices</button></td>
            <td><button class='imgButtonBig' id='btnWodAddRest'>Repos</button></td>
            <td><button class='imgButtonBig' id='btnWodAddSerie'>Série</button></td>
        </tr>
    </table>
</div>
<script>
    // wod page actions
    var wodPage = {
        wodItems: [],
        selectedWodItems: [],
        
        // init page components
        initialise: () => {
            let result = $.Deferred();
            result.resolve();
            return result.promise();
        },
        // Add Rest item
        addWodRestItem:() => {
            let idRandom = new Date().getTime();
            wodPage.wodItems.push(new WodItem('REST', idRandom, "Repos (secondes)", 30, "sec"));
            wodPage.renderWodItems();
        },
        // Add Rest item
        addWodSerieItem:() => {
            let idRandom = new Date().getTime();
            wodPage.wodItems.push(new WodItem('SERIE', idRandom, "Série (Loop)", 5, "rep"));
            wodPage.renderWodItems();
        },
        // Add WOD item
        addWodItem: () => {
            popinManager.setCallbackFunction('wodPage.validateWodItems()');
            popinManager.load('OKCancel').done(() => {
                pageManager.renderElement('wod/popinSelectWodItems', null, 'tdPopinContent').done((html) => {
                    let get1 = dataManager.getCategories();
                    let get2 = dataManager.getDifficultes();
                    let get3 = dataManager.getZones();
                    $.when(get1, get2, get3).done((data1, data2, data3) => {
                        data1.splice(0,0,new Categorie(-1,"-"));
                        let render1 = pageManager.renderElement('selectElement', data1, 'divCritereCateg');
                        data2.splice(0,0,new Difficulte(-1,"-"));
                        let render2 = pageManager.renderElement('selectElement', data2, 'divCritereDiff'); 
                        data3.splice(0,0,new Zone(-1,"-"));
                        let render3 = pageManager.renderElement('selectElement', data3, 'divCritereZone');
                        $.when(render1, render2, render3).done(() => {
                            $("#divCritereCateg select").data("type","categ");
                            $("#divCritereDiff select").data("type","diff");
                            $("#divCritereZone select").data("type","zone");
                            $("#tdPopinContent select").on("change", () => { wodPage.filterWodItems(); });
                            $("#btnWodItemsClear").on("click", () => {
                                $('#tdPopinContent select').val(-1);
                                wodPage.filterWodItems();    
                            });
                            wodPage.filterWodItems();
                            wodPage.selectedWodItems = [];
                            popinManager.show();
                        });
                    });
                });
            });
        },
        // Render wod items list on wod page
        renderWodItems:() => {
            let result = $.Deferred();
            pageManager.renderElement('wod/listExoWod', wodPage.wodItems, 'tblWodItems').done(()=>{
                $("#tblWodItems #btnDeleteExerc").on("click", (obj) => {
                    let parent = $(obj.currentTarget).parents('.trWodRow');
                    let id = $(parent).data('id');
                    wodPage.wodItems.forEach((item, index) => {
                        if (item.exerciceId==id) {
                            wodPage.wodItems.splice(index,1);
                        };
                    });
                    wodPage.renderWodItems();
                });

                // set values
                wodPage.wodItems.forEach((item) => {
                    $(".trWodRow[data-id='" + item.exerciceId + "'] input").val(item.quantite);
                    $(".trWodRow[data-id='" + item.exerciceId + "'] .selUnite").val(item.unite);
                });
                
                result.resolve();
            });
            return result.promise();
        },
        // Validate Wod items selection
        validateWodItems: (data) => {
            let listIdExoSelected = [];
            wodPage.selectedWodItems.forEach((item) => {
                listIdExoSelected.push(item*1);
            });
            dataManager.getExercicesByIds(listIdExoSelected).done(function(listExo) {
                let listWodItems = [];
                listExo.forEach((exo) => {
                    listWodItems.push(new WodItem('EXO', exo.id, exo.nom, 10, exo.unite));
                });
                wodPage.wodItems = wodPage.wodItems.concat(listWodItems);
                wodPage.renderWodItems();
            });
        },
        // Select a Wod on the selection list (add it to selecteditems)
        selectWodItem:(obj) => {
            let parent = $(obj).parents('.trWodItem');
            let dataKeyForm = $(parent).children('.keyForm');
            let id = $(dataKeyForm).attr('field');
            if (obj.checked) {
                wodPage.selectedWodItems.push(id);
            }
            else {
                let pos = wodPage.selectedWodItems.indexOf(id);
                wodPage.selectedWodItems.splice(pos,1);
            }
        },
        // check selected items on content change
        checkSelectedItems:() => {
            if (wodPage.selectedWodItems.length>0) {
                $.each($(".trWodItem"), function(i, item) {
                    let tdData = $(item).children('.keyForm');
                    let currentId = $(tdData).attr('field');
                    if (wodPage.selectedWodItems.indexOf(currentId)>-1) {
                        let checkBox = $(item).find('#chkExoWodChecked');
                        $(checkBox).prop('checked', true);
                    } 
                });
            }
        },
        // Filter items on addWodItem popin
        filterWodItems:() => {
            // Search exercices
            let listCriteresElements = [$("#divCritereCateg select"),$("#divCritereZone select"),$("#divCritereDiff select")];
            filterManager.filterExercices(listCriteresElements).done(function(results) {
                pageManager.renderElement('wod/listExoWodSelect', results, 'divWodItemsResults').done(()=>{
                    // Replace ids with values
                    $('.tblExoListWod td').each(function(){
                        let data = $(this).data();
                        if (data) {
                            if (data.categ) {
                                dataManager.getCategorie(data.categ).done((item) => {
                                   $(this).html(item.nom); 
                                });
                            }
                            if (data.diff) {
                                dataManager.getDifficulte(data.diff).done((item) => {
                                   $(this).html(item.nom); 
                                });
                            }
                        }
                    });
                    // Check selected items
                    wodPage.checkSelectedItems();
                })
            });
        },
        // Edit the WOD Name
        editWodName:() => {
            if ($("#btnEditWodName").hasClass('edit')) {
                let object = new injectableObject();
                object.value = $("#tdWodName").html();
                pageManager.renderElement('wod/editWodName', [object], 'tdWodName').done(()=>{
                    $("#btnEditWodName").toggleClass(['edit','save']);
                });
            }
            if ($("#btnEditWodName").hasClass('save')) {
                $("#tdWodName").html($("#txtWodName").val());
                $("#btnEditWodName").toggleClass(['edit','save']);
            }
        },
        // Swith to running state (desactivate GUI editing mode)
        DesactivateEditionMode: () => {
            // exit name edition mode & hide button
            if ($("#btnEditWodName").hasClass('save')) wodPage.editWodName();
            $("#btnEditWodName").hide();
            
            // Switch to display mode
            $("#btnWodAddExo").hide();
            $("#btnWodAddRest").hide();
            $("#btnWodAddSerie").hide();
            $("#tblWodItems #btnDeleteExerc").hide();
            $(".trWodRow input").attr('readonly', true);
            $(".trWodRow input").toggleClass('readonly');
            $(".trWodRow .selUnite option").attr('disabled', 'disabled');
            $(".trWodRow .selUnite").toggleClass('readonly');
        }
    };

    // run wods
    var wodRunner = {
        currentWod: {},
        listWodItems: [],
        // Start the wod
        startWod:() => {
            // Check currentWod
            if (wodRunner.currentWod.id) return;
            
            // Check exercices
            let exercices = wodPage.wodItems.filter((item) => { if (item.type=='EXO') return item; });
            if (exercices.length==0) return;

            // Desactivate edition mode
            wodPage.DesactivateEditionMode();
            
            // Create WOD
            let wodName = $("#tdWodName").html();
            let idRandom = new Date().getTime();
            wodRunner.currentWod = new Wod(idRandom, wodName, wodPage.wodItems);
            
            // add start date
            wodRunner.currentWod.dateDebut = new Date().toUTCString();
            
            // Add to recent
            // dataManager.addWodToRecent(wodRunner.currentWod);
            
            // start wod
            wodRunner.listWodItems.push(wodRunner.currentWod.wodItems[0]);
            pageManager.renderElement('popin/popinWod', null, 'divPopin').done(() => {
                pageManager.renderElement('wod/currentWodPopin', [wodRunner.currentWod], 'tdPopinContent').done(()=>{
                    pageManager.renderElement('wod/listWodItems', wodRunner.listWodItems, 'tdListWodItems').done(()=>{
                        popinManager.show();
                    });
                });
            });
        }
    };
    
    wodPage.initialise().done(() => {
        // update current wod name
        let date = new Date();
        $("#tdWodName").html("Wod du " + date.toLocaleDateString() + ' à ' + date.toLocaleTimeString());

        // buttons clic
        $("#btnWodAddExo").click(()=>wodPage.addWodItem());
        $("#btnWodAddRest").click(()=>wodPage.addWodRestItem());
        $("#btnWodAddSerie").click(()=>wodPage.addWodSerieItem());
        $("#btnEditWodName").click(()=>wodPage.editWodName());
    });
    
</script>