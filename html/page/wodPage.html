<div>
    <table id='tblWodTitleDate'>
        <tr>
            <td>WOD du</td><td><div id='divDateWod'></div></td>
        </tr>
    </table>
    <hr/>
    <table id='tblWodItems'></table>
    <br/>
    <table id='tblWodActions'>
        <tr>
            <td><button id='btnWodAddExo'>Ajouter des exercices...</button></td>
        </tr>
    </table>
</div>
<script>
    var wodPage = {
        wodItems: [],
        
        // init page components
        initialise: () => {
            let result = $.Deferred();
            result.resolve();
            return result.promise();
        },
        // Add WOD item
        addWodItem: () => {
            popinManager.setCallbackFunction('wodPage.validateWodItems()');
            popinManager.load('OKCancel').done(() => {
                pageManager.renderElement('wod/popinSelectWodItems', null, 'tdPopinContent').done((html) => {
                    let get1 = dataManager.getCategories();
                    let get2 = dataManager.getDifficultes();
                    let get3 = dataManager.getZones();
                    $.when(get1, get2, get3).done((data1, data2, data3) => {
                        data1.splice(0,0,new Categorie(-1,"-", "-"));
                        let render1 = pageManager.renderElement('selectElement', data1, 'divCritereCateg');
                        data2.splice(0,0,new Difficulte(-1,"-"));
                        let render2 = pageManager.renderElement('selectElement', data2, 'divCritereDiff'); 
                        data3.splice(0,0,new Zone(-1,"-"));
                        let render3 = pageManager.renderElement('selectElement', data3, 'divCritereZone');
                        $.when(render1, render2, render3).done(() => {
                            $("#divCritereCateg select").data("type","categ");
                            $("#divCritereDiff select").data("type","diff");
                            $("#divCritereZone select").data("type","zone");
                            $("#tdPopinContent select").on("change", () => { wodPage.filterWodItems(); });
                            $("#btnWodItemsClear").on("click", () => {
                                $('#tdPopinContent select').val(-1);
                                wodPage.filterWodItems();    
                            });
                            wodPage.filterWodItems();
                            popinManager.show();
                        });
                    });
                });
            });
        },
        // Validate Wod items selection
        validateWodItems: (data) => {
            let listIdExoSelected = [];
            let arrayData = data.split("|");
            arrayData.forEach((item) => {
                let itemSplit = item.split('=');
                if (itemSplit[1]=='true') {
                    listIdExoSelected.push(itemSplit[0]*1);
                }
            });
            dataManager.getExercicesByIds(listIdExoSelected).done(function(listExo) {
                wodPage.wodItems = wodPage.wodItems.concat(listExo);
                pageManager.renderElement('wod/listExoWod', wodPage.wodItems, 'tblWodItems').done(()=>{
                    $("#tblWodItems button").on("click", (obj) => {
                        let parent = $(obj.currentTarget).parents('.trWodRow');
                        let id = $(parent).data('id');
                        console.log("delete : " + id);
                    });
                });
            });
        },
        // Filter items on addWodItem popin
        filterWodItems:() => {
            // Search exercices
            let listCriteresElements = [$("#divCritereCateg select"),$("#divCritereZone select"),$("#divCritereDiff select")];
            filterManager.filterExercices(listCriteresElements).done(function(results) {
                pageManager.renderElement('wod/listExoWodSelect', results, 'divWodItemsResults').done(()=>{
                    // Replace ids with values
                    $('.tblExoListWod td').each(function(){
                        let data = $(this).data();
                        if (data) {
                            if (data.categ) {
                                dataManager.getCategorie(data.categ).done((item) => {
                                   $(this).html(item.nom); 
                                });
                            }
                            if (data.diff) {
                                dataManager.getDifficulte(data.diff).done((item) => {
                                   $(this).html(item.nom); 
                                });
                            }
                        }
                    }); 
                })
            });
        }
    }
    wodPage.initialise().done(() => {
        // update current datetime
        let date = new Date();
        $("#divDateWod").html(date.toLocaleDateString() + ' Ã  ' + date.toLocaleTimeString());

        // buttons clic
        $("#btnWodAddExo").click(()=>{
            wodPage.addWodItem();
        });
    });
</script>